// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum AuthRole {
  USER
  ADMIN
  SUPER_ADMIN
  SUPPORT
}

enum ScheduleDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ExpenseEntryType {
  INCOME
  EXPENSE
  TRANSFER
}

enum ExerciseType {
  REPS
  TIME
}

enum ActivityRepeatType {
  DAILY // every day
  WEEKDAYS // specific days of the week (Mon/Wed/Fri)
  INTERVAL // every N days
  DATES // specific calendar dates
  FREQUENCY // X times per week/month (e.g. gym 3x/week)
}

enum ActivityTargetType {
  BOOLEAN
  QUANTITY
}

enum ActivityTargetUnit {
  PAGES
  MINUTES
  KM
  TIMES // for frequency-based (run 3 times/week)
  CUSTOM // user-defined unit label
}

enum FrequencyPeriod {
  WEEK
  MONTH
}

enum OccurrenceStatus {
  PENDING
  COMPLETED
  SKIPPED
  FAILED // missed without being explicitly skipped
}

model User {
  id         Int      @id @default(autoincrement())
  uuid       String   @unique @default(uuid())
  email      String   @unique
  phone      String?  @unique
  password   String
  first_name String
  last_name  String
  role       AuthRole
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Routine
  activities           Activity[]
  schedule_slots       ScheduleSlot[]
  activity_schedules   ActivitySchedule[]
  activity_logs        ActivityLog[]
  activity_occurrences ActivityOccurrence[]
  hidden_activities    HiddenActivity[]

  // Expenses
  expense_accounts     ExpenseAccount[]
  expense_entries      ExpenseEntry[]
  categories           ExpenseCategory[]
  subcategories        ExpenseSubcategory[]
  hidden_categories    HiddenCategory[]
  hidden_subcategories HiddenSubcategory[]

  // Receipts
  expense_receipts ExpenseReceipt[]
  expense_stores   ExpenseStore[]
  expense_products ExpenseProduct[]

  // Gym
  muscle_groups MuscleGroup[]
  exercises     Exercise[]
  workouts      Workout[]

  @@index([email])
  @@index([phone])
  @@index([uuid])
  @@map("users")
}

model Activity {
  id          Int      @id @default(autoincrement())
  uuid        String   @unique @default(uuid())
  user_uuid   String
  name        String
  description String?
  icon        String?
  color       String?
  visible     Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user                 User                 @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  schedule_slots       ScheduleSlot[]
  activity_schedules   ActivitySchedule[]
  activity_logs        ActivityLog[]
  activity_occurrences ActivityOccurrence[]
  hidden_activities    HiddenActivity[]

  @@index([uuid])
  @@index([user_uuid])
  @@map("activities")
}

model ScheduleSlot {
  id            Int         @id @default(autoincrement())
  uuid          String      @unique @default(uuid())
  user_uuid     String
  activity_uuid String
  day           ScheduleDay
  start_time    String
  end_time      String
  created_at    DateTime    @default(now())
  updated_at    DateTime    @updatedAt

  user     User     @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  activity Activity @relation(fields: [activity_uuid], references: [uuid], onDelete: Cascade)

  @@index([uuid])
  @@index([user_uuid])
  @@index([day])
  @@map("schedule_slots")
}

model ActivitySchedule {
  id                Int                 @id @default(autoincrement())
  uuid              String              @unique @default(uuid())
  user_uuid         String
  activity_uuid     String
  // When this schedule config is active
  valid_from        DateTime            @default(now())
  valid_until       DateTime? // null = currently active
  // Repeat configuration
  repeat_type       ActivityRepeatType
  interval_days     Int? // used when repeat_type = INTERVAL
  time_of_day       String? // "17:00" — store as HH:MM string
  // Frequency config (e.g. 3 times per week)
  frequency_value   Int? // e.g. 3
  frequency_period  FrequencyPeriod? // e.g. WEEK
  // Target config — snapshotted per schedule version
  target_type       ActivityTargetType
  target_value      Float?
  target_unit       ActivityTargetUnit?
  target_unit_label String? // for CUSTOM unit, e.g. "laps"
  is_active         Boolean             @default(true)
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt

  activity       Activity                  @relation(fields: [activity_uuid], references: [uuid], onDelete: Cascade)
  user           User                      @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  weekdays       ActivityScheduleWeekday[]
  specific_dates ActivityScheduleDate[]
  occurrences    ActivityOccurrence[]
  logs           ActivityLog[]

  @@index([activity_uuid])
  @@index([user_uuid])
  @@index([valid_from])
  @@map("activity_schedules")
}

// Which weekdays the activity repeats on (Mon=1 ... Sun=7, ISO)
model ActivityScheduleWeekday {
  id            Int    @id @default(autoincrement())
  schedule_uuid String
  weekday       Int // 1=Mon, 7=Sun

  schedule ActivitySchedule @relation(fields: [schedule_uuid], references: [uuid], onDelete: Cascade)

  @@unique([schedule_uuid, weekday])
  @@map("activity_schedule_weekdays")
}

// Specific calendar dates for one-off or irregular schedules
model ActivityScheduleDate {
  id            Int      @id @default(autoincrement())
  schedule_uuid String
  date          DateTime // just the date portion matters

  schedule ActivitySchedule @relation(fields: [schedule_uuid], references: [uuid], onDelete: Cascade)

  @@unique([schedule_uuid, date])
  @@map("activity_schedule_dates")
}

// An "occurrence" is one expected instance of an activity on a given date.
// Your backend generates these (e.g. daily cron or on-demand for the next 30 days).
// This is what the user checks off. Separating this from the log lets you
// distinguish "not done yet" vs "skipped" vs "completed".
model ActivityOccurrence {
  id            Int              @id @default(autoincrement())
  uuid          String           @unique @default(uuid())
  user_uuid     String
  activity_uuid String
  schedule_uuid String
  scheduled_for DateTime // the date (and implied time) this is due
  status        OccurrenceStatus @default(PENDING)
  created_at    DateTime         @default(now())
  updated_at    DateTime         @updatedAt

  activity Activity         @relation(fields: [activity_uuid], references: [uuid], onDelete: Cascade)
  schedule ActivitySchedule @relation(fields: [schedule_uuid], references: [uuid], onDelete: Cascade)
  user     User             @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  log      ActivityLog? // one-to-one: log is created when user acts on it

  @@unique([schedule_uuid, scheduled_for])
  @@index([user_uuid, scheduled_for])
  @@index([activity_uuid])
  @@map("activity_occurrences")
}

model ActivityLog {
  id              Int    @id @default(autoincrement())
  uuid            String @unique @default(uuid())
  user_uuid       String
  activity_uuid   String
  schedule_uuid   String
  occurrence_uuid String @unique // one log per occurrence

  // Snapshot of the goal AT THE TIME of this log entry
  // This is critical — don't rely on schedule.target_value for history
  snapshot_target_type       ActivityTargetType
  snapshot_target_value      Float?
  snapshot_target_unit       ActivityTargetUnit?
  snapshot_target_unit_label String?

  // What the user actually did
  value        Float? // actual quantity completed
  completed    Boolean   @default(false)
  completed_at DateTime? // set explicitly when user marks done
  skipped      Boolean   @default(false)
  skip_reason  String?

  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  activity   Activity           @relation(fields: [activity_uuid], references: [uuid], onDelete: Cascade)
  schedule   ActivitySchedule   @relation(fields: [schedule_uuid], references: [uuid], onDelete: Cascade)
  occurrence ActivityOccurrence @relation(fields: [occurrence_uuid], references: [uuid], onDelete: Cascade)
  user       User               @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)

  @@index([user_uuid])
  @@index([activity_uuid])
  @@index([completed_at])
  @@index([schedule_uuid])
  @@map("activity_logs")
}

model ExpenseAccount {
  id         Int      @id @default(autoincrement())
  uuid       String   @unique @default(uuid())
  user_uuid  String
  name       String
  icon       String?
  color      String?
  balance    Decimal  @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user         User           @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  entries_from ExpenseEntry[] @relation("EntryFromAccount")
  entries_to   ExpenseEntry[] @relation("EntryToAccount")

  @@index([user_uuid])
  @@map("expense_accounts")
}

model ExpenseCategory {
  id         Int      @id @default(autoincrement())
  uuid       String   @unique @default(uuid())
  user_uuid  String?
  name       String
  icon       String?
  color      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user              User?                @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  subcategories     ExpenseSubcategory[]
  entries           ExpenseEntry[]
  products          ExpenseProduct[]
  hidden_categories HiddenCategory[]

  @@index([user_uuid])
  @@map("categories")
}

model ExpenseSubcategory {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  user_uuid     String?
  category_uuid String
  name          String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user                 User?               @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  category             ExpenseCategory     @relation(fields: [category_uuid], references: [uuid], onDelete: Cascade)
  entries              ExpenseEntry[]
  products             ExpenseProduct[]
  hidden_subcategories HiddenSubcategory[]

  @@index([category_uuid])
  @@map("subcategories")
}

model ExpenseEntry {
  id                Int              @id @default(autoincrement())
  uuid              String           @unique @default(uuid())
  user_uuid         String
  type              ExpenseEntryType
  amount            Decimal
  description       String?
  from_account_uuid String
  to_account_uuid   String?
  category_uuid     String?
  subcategory_uuid  String?
  entry_date        DateTime         @default(now())
  created_at        DateTime         @default(now())
  updated_at        DateTime         @updatedAt

  user            User                @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  from_account    ExpenseAccount      @relation("EntryFromAccount", fields: [from_account_uuid], references: [uuid], onDelete: Cascade)
  to_account      ExpenseAccount?     @relation("EntryToAccount", fields: [to_account_uuid], references: [uuid], onDelete: Cascade)
  category        ExpenseCategory?    @relation(fields: [category_uuid], references: [uuid], onDelete: Cascade)
  subcategory     ExpenseSubcategory? @relation(fields: [subcategory_uuid], references: [uuid], onDelete: Cascade)
  expense_receipt ExpenseReceipt?

  @@index([user_uuid])
  @@index([category_uuid])
  @@index([subcategory_uuid])
  @@index([entry_date])
  @@map("expense_entries")
}

model ExpenseStore {
  id         Int      @id @default(autoincrement())
  uuid       String   @unique @default(uuid())
  user_uuid  String?
  name       String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user     User?            @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  receipts ExpenseReceipt[]

  @@index([user_uuid])
  @@map("expense_stores")
}

model ExpenseReceipt {
  id                 Int      @id @default(autoincrement())
  uuid               String   @unique @default(uuid())
  user_uuid          String
  store_uuid         String?
  expense_entry_uuid String   @unique
  receipt_date       DateTime @default(now())
  total_amount       Decimal
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  user          User                 @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  store         ExpenseStore?        @relation(fields: [store_uuid], references: [uuid], onDelete: SetNull)
  expense_entry ExpenseEntry         @relation(fields: [expense_entry_uuid], references: [uuid], onDelete: Cascade)
  items         ExpenseReceiptItem[]

  @@index([user_uuid])
  @@index([store_uuid])
  @@map("expense_receipts")
}

model ExpenseProduct {
  id               Int      @id @default(autoincrement())
  uuid             String   @unique @default(uuid())
  user_uuid        String?
  name             String
  brand            String?
  unit             String?
  size             Decimal?
  category_uuid    String?
  subcategory_uuid String?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  user          User?                @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  category      ExpenseCategory?     @relation(fields: [category_uuid], references: [uuid], onDelete: SetNull)
  subcategory   ExpenseSubcategory?  @relation(fields: [subcategory_uuid], references: [uuid], onDelete: SetNull)
  receipt_items ExpenseReceiptItem[]

  @@index([user_uuid])
  @@index([category_uuid])
  @@index([subcategory_uuid])
  @@map("expense_products")
}

model ExpenseReceiptItem {
  id           Int      @id @default(autoincrement())
  uuid         String   @unique @default(uuid())
  receipt_uuid String
  product_uuid String?
  quantity     Decimal  @default(1)
  unit_price   Decimal
  total_price  Decimal
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  receipt ExpenseReceipt  @relation(fields: [receipt_uuid], references: [uuid], onDelete: Cascade)
  product ExpenseProduct? @relation(fields: [product_uuid], references: [uuid], onDelete: SetNull)

  @@index([receipt_uuid])
  @@map("expense_receipt_items")
}

model MuscleGroup {
  id         Int      @id @default(autoincrement())
  uuid       String   @unique @default(uuid())
  user_uuid  String?
  name       String
  color      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user      User?      @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  exercises Exercise[]

  @@index([user_uuid])
  @@map("muscle_groups")
}

model Exercise {
  id                Int          @id @default(autoincrement())
  uuid              String       @unique @default(uuid())
  user_uuid         String?
  muscle_group_uuid String
  name              String
  description       String?
  type              ExerciseType
  created_at        DateTime     @default(now())
  updated_at        DateTime     @updatedAt

  user         User?          @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  muscle_group MuscleGroup    @relation(fields: [muscle_group_uuid], references: [uuid], onDelete: Cascade)
  entries      WorkoutEntry[]

  @@index([user_uuid])
  @@index([muscle_group_uuid])
  @@map("exercises")
}

model Workout {
  id          Int      @id @default(autoincrement())
  uuid        String   @unique @default(uuid())
  user_uuid   String?
  name        String?
  notes       String?
  started_at  DateTime @default(now())
  finished_at DateTime @updatedAt
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user    User?          @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  entries WorkoutEntry[]

  @@index([user_uuid])
  @@index([started_at])
  @@map("workouts")
}

model WorkoutEntry {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  workout_uuid  String
  exercise_uuid String
  order         Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  workout  Workout      @relation(fields: [workout_uuid], references: [uuid], onDelete: Cascade)
  exercise Exercise     @relation(fields: [exercise_uuid], references: [uuid], onDelete: Cascade)
  sets     WorkoutSet[]

  @@index([workout_uuid])
  @@index([exercise_uuid])
  @@map("workout_entries")
}

model WorkoutSet {
  id                 Int          @id @default(autoincrement())
  uuid               String       @unique @default(uuid())
  workout_entry_uuid String
  type               ExerciseType
  reps               Int?
  weight             Decimal?
  duration_seconds   Int?
  distance_meters    Int?
  rest_seconds       Int?
  notes              String?
  is_dropset         Boolean      @default(false)
  is_amrap           Boolean      @default(false)
  is_rest            Boolean      @default(false)
  is_warmup          Boolean      @default(false)
  is_cooldown        Boolean      @default(false)
  is_super_set       Boolean      @default(false)
  order              Int          @default(0)
  created_at         DateTime     @default(now())
  updated_at         DateTime     @updatedAt

  workout_entry WorkoutEntry @relation(fields: [workout_entry_uuid], references: [uuid], onDelete: Cascade)

  @@index([workout_entry_uuid])
  @@index([order])
  @@map("workout_sets")
}

model HiddenActivity {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  user_uuid     String
  activity_uuid String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user     User     @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  activity Activity @relation(fields: [activity_uuid], references: [uuid], onDelete: Cascade)
}

model HiddenCategory {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  user_uuid     String
  category_uuid String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user     User            @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  category ExpenseCategory @relation(fields: [category_uuid], references: [uuid], onDelete: Cascade)

  @@index([user_uuid])
  @@index([category_uuid])
  @@map("expense_hidden_categories")
}

model HiddenSubcategory {
  id               Int      @id @default(autoincrement())
  uuid             String   @unique @default(uuid())
  user_uuid        String
  subcategory_uuid String
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  user        User               @relation(fields: [user_uuid], references: [uuid], onDelete: Cascade)
  subcategory ExpenseSubcategory @relation(fields: [subcategory_uuid], references: [uuid], onDelete: Cascade)

  @@index([user_uuid])
  @@index([subcategory_uuid])
  @@map("expense_hidden_subcategories")
}
